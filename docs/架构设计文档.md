# 架构设计文档

本文档描述 boq 的新架构形态，强调面向对象与模块化设计，明确各组件职责与协作关系。

## 1. 设计原则

- 面向对象：容器后端、存储策略、配置、生命周期管理均为明确对象。
- 强分层：CLI 与业务逻辑分离；运行时与存储实现解耦。
- 可替换：不同 OS/FS 的隔离机制通过策略模式切换。
- 易扩展：新增后端或文件系统支持应仅增加新类实现。

## 2. 总体模块划分

### 2.1 CLI 层

**模块**：`cli`
- 负责命令行解析与输出
- 仅调用应用层接口，不包含实现细节

### 2.2 应用层（Facade）

**模块**：`app` 或 `boq_app`
- 统一编排 create/enter/run/stop/destroy/diff/status/list
- 将请求分发给容器后端与存储策略
- 处理流程级别的错误与用户提示

### 2.3 领域层

#### 2.3.1 容器后端（Backend）

**接口**：`ContainerBackend`
- `create_container(...)`
- `start_container(...)`
- `exec_shell(...)`
- `exec_cmd(...)`
- `stop_container(...)`
- `remove_container(...)`
- `inspect_status(...)`
- `ensure_network(...)`

**实现**：
- `DockerBackend`
- `PodmanBackend`

说明：
- 所有与 docker/podman 相关的命令构建与执行全部封装在 Backend 内。
- sudo/非 sudo 行为由 Backend 处理。

#### 2.3.2 存储策略（Storage Strategy）

**接口**：`StorageStrategy`
- `prepare(...)`  创建隔离环境
- `mount(...)`    挂载（仅 overlayfs）
- `unmount(...)`  卸载（仅 overlayfs）
- `diff(...)`     差异检测
- `destroy(...)`  清理

**实现**：
- `ApfsCowStrategy` (macOS)
- `ReflinkCowStrategy` (Linux reflink)
- `OverlayFsStrategy` (ext4)

说明：
- 负责 OS/FS 判断与能力检测。
- 统一暴露“工作根路径”给容器层使用。

#### 2.3.3 文件系统探测与能力检测

**模块**：`fs_probe`
- 判断当前 OS
- 判断路径所在文件系统类型
- 检测 reflink 是否可用
- 检测 APFS CoW 能力

### 2.4 配置层

**模块**：`config`
- 解析 defaults + user + instance 三级配置
- 变量展开
- 强类型校验

### 2.5 运行时与锁管理

**模块**：`lock` / `runtime`
- 全局锁与实例锁
- 安全删除与清理
- 协调 create/destroy/enter 并发

## 3. 组件交互关系

1. CLI -> App
2. App 根据 OS/FS 选择 StorageStrategy
3. App 根据配置与运行态选择 ContainerBackend
4. StorageStrategy 产出“工作根”与挂载信息
5. ContainerBackend 使用工作根作为 volume/mount
6. 生命周期结束时，App 调用 StorageStrategy 清理

## 4. 数据与状态模型

### 4.1 实例状态

- `name`
- `root_dir`
- `storage_mode` (apfs/reflink/overlay)
- `backend` (docker/podman)
- `network_mode`
- `ip`
- `running`

### 4.2 存储结构

- CoW 副本：`~/.boq/<name>/cow_root` (可配置)
- overlayfs：`~/.boq/<name>/<overlay>/upper|work|merged`
- metadata：`~/.boq/<name>/settings.json`

## 5. 关键类示意

- `BoqApp`
  - `create(name, ...)`
  - `enter(name, ...)`
  - `run(name, cmd, ...)`
  - `stop(name)`
  - `destroy(name)`

- `ContainerBackend`
  - `DockerBackend`
  - `PodmanBackend`

- `StorageStrategy`
  - `ApfsCowStrategy`
  - `ReflinkCowStrategy`
  - `OverlayFsStrategy`

- `ConfigManager`
- `FsProbe`
- `LockManager`

## 6. 未来扩展点

- 新文件系统（btrfs 等）只需新增 Strategy。
- 新容器运行时（containerd 或其他）只需新增 Backend。
- diff 功能可抽象成策略内实现，支持多种对比机制。

