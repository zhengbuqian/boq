# 功能文档

本文档描述 boq 的下一代设计目标与功能划分，重点覆盖不同操作系统与文件系统下的隔离实现方式，以及相关功能的边界与策略。

## 1. 目标与范围

- 目标：提供“与主机体验一致”的隔离开发环境，通过文件系统 CoW 或 overlayfs 实现写时隔离，支持 docker/podman 容器后端。
- 范围：主机为 macOS / Linux；文件系统重点覆盖 APFS、XFS(reflink)、ext4；容器后端为 Docker 和 Podman。

## 2. 操作系统与文件系统支持矩阵

### 2.1 macOS (APFS)

- 机制：使用 APFS 的 CoW 复制能力。
- 复制策略：以 `cp -c` 进行目录/文件复制，生成“轻量副本”作为工作副本。
- 目标：不依赖 overlayfs，直接通过 APFS CoW 实现隔离。
- 说明：运行时需要确认 APFS 可用，并针对不同 macOS 版本提供兼容性检查。

### 2.2 Linux

#### 2.2.1 XFS (reflink enabled) / 其他支持 reflink 的文件系统

- 机制：使用 reflink 的 CoW 复制能力。
- 复制策略：优先使用 `cp --reflink=always`（或等效工具），创建 CoW 副本作为工作副本。
- 目标：尽量不使用 overlayfs，改用 reflink CoW 更简单的隔离副本方案。
- 说明：
  - 需要检测目标文件系统是否支持并启用 reflink。
  - 如果 reflink 不可用，需回退到 overlayfs（仅对 ext4 的情况适用）。

#### 2.2.2 ext4

- 机制：使用 kernel overlayfs。
- 复制策略：不进行 CoW 复制，使用 overlayfs 的 upper/work/merged 结构进行写时隔离。
- 说明：这是在 ext4 上的唯一可选方案。

## 3. 核心能力与功能划分

### 3.1 隔离方式选择

- 按 OS / FS 自动选择：
  - macOS + APFS -> CoW (cp -c)
  - Linux + reflink -> CoW (cp --reflink=always)
  - Linux + ext4 -> overlayfs
- 选择逻辑应集中在“存储策略层”统一决策，避免业务层散落判断。

### 3.2 容器后端管理

- 后端：Docker / Podman。
- 统一接口：创建、启动、执行、停止、销毁、状态获取、网络与挂载配置。
- 支持 sudo/非 sudo 模式（后端内部处理）。

### 3.3 网络与 IP 策略

- Linux：支持静态 IP 分配（主机访问容器）。
- Docker：管理自建网络或 host/none 模式。
- Podman：支持 rootful/rootless 行为区分。
- macOS：容器网络策略与 Docker Desktop 特性保持一致。

### 3.4 配置系统

- 分层配置：默认配置 + 用户级 + 实例级覆盖。
- 保留变量展开与 list append/replace 语义。
- 新架构下应提供强类型配置模型与校验。

### 3.5 运行期命令

- create / enter / run / stop / destroy / diff / status / list / completion / version。
- 其中 `diff` 的行为需根据存储策略不同而不同（overlayfs 的 diff vs CoW 副本差异比对）。

## 4. 关键行为策略

### 4.1 CoW 副本模式下的“隔离语义”

- 复制后产生“工作目录副本”，容器以副本为工作根。
- 与 overlayfs 不同，CoW 是“完整副本 + 写时共享块”。
- 必须明确“副本根路径”和“源路径”的映射关系。

### 4.2 overlayfs 模式下的“隔离语义”

- 使用 upper/work/merged 结构，写时在 upper 中保存修改。
- 需要 mount/unmount 生命周期管理。

### 4.3 存储清理与回收

- CoW 副本：删除副本目录即可回收空间。
- overlayfs：卸载后删除 upper/work/merged 目录。
- 所有清理流程必须有安全保护（防误删）。

## 5. 兼容性取舍

- 不考虑旧实例兼容性，允许迁移逻辑被简化。
- CLI 行为可重构，但核心命令集合保持一致，减少用户心智迁移。

